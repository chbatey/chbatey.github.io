---
layout: post
title: 'Cassandra Datastax Java Driver: Implementing your own retry policy'
date: '2013-10-03T08:44:00.000-07:00'
author: Christopher Batey
tags: 
modified_time: '2013-10-03T08:44:04.693-07:00'
blogger_id: tag:blogger.com,1999:blog-4161315644722406995.post-3282524841937342732
blogger_orig_url: https://www.blogger.com/comment.g?blogID=4161315644722406995&postID=3282524841937342732
---

The Datastax Java driver comes with a pluggable strategy for query retry, I blogged about it here:&nbsp;<a href="http://christopher-batey.blogspot.co.uk/2013/10/cassandra-datastax-java-driver-retry.html">retry policy</a><br /><br />There is a very simple interface to implement if you want to create a custom policy called&nbsp;<a href="http://www.datastax.com/drivers/java/2.0/apidocs/com/datastax/driver/core/policies/RetryPolicy.html">RetryPolicy</a>.<br /><br />This allows you to decide what happens for read/write/unavailable timeouts. The information you are given is extensive:<br /><ul><li>For all types of timeout:</li><ul><li>The statement that was executed</li><li>Consistency level</li><li>Number of times retried</li></ul><li>For read timeouts:</li><ul><li>Required responses and the number of responses</li><li>Whether the data came back</li></ul><li>For write timeouts:</li><ul><li>Required acks and received acks for the write</li><li>The write type - see&nbsp;<a href="http://www.datastax.com/drivers/java/2.0/apidocs/com/datastax/driver/core/WriteType.html">WriteType</a></li></ul><li>For unavailable:</li><ul><li>Required replica and available replica</li></ul></ul><div>One thing to note about the current implementations of the interface is they are all stateless. Making their implementations very simple. I've had requirements for two additional policies, one stateless like the ones provided, but also one that would require state. These are:</div><div><ol><li>Retry N times - very simple but missing. Here I want to retry the query N times regardless of the number of responses/replica available etc. This can use the number of retries passed into the interface so will be very easy to implement.</li><li>Downgrading consistency retry. Sound familiar? Yes Datastax provide this here:&nbsp;http://www.datastax.com/drivers/java/2.0/apidocs/com/datastax/driver/core/policies/DowngradingConsistencyRetryPolicy.html. However the problem with this policy is it is per query. What I'd like is a policy that remembers that the say queries at LOCAL_QUORUM have been failing so there must be issues so lets use a lower consistency to give the cluster a chance to repair. This policy is inherently more complicated so will be the topic of my next blog post.</li></ol><h4>Implementing the N retry policy</h4></div><div><br />I've gone a head and forked and cloned the driver&nbsp;<a href="https://github.com/chbatey/java-driver" target="_blank">(github)</a> as this is such a generic policy but normally I'd have it in my own or a separate project.</div><div><br /></div><div>Here's the behaviour I want my retry policy to have:</div><ul><li>It should Read Retry At The Same Consistency Level</li><li>It should Read Retry If Number Of Retries Less Than Configured Retries</li><li>It should Not Read Retry If Number Of Retries Greater Than Configured Retries</li><li>It should Not Read Retry If Number Of Retries Equal To Configured Retries</li></ul><br /><div class="p2">Write behaviour:</div><div class="p1"></div><ul><li>It should Write Retry At The Same Consistency Level</li><li>It should Write Retry If Number Of Retries Less Than Configured Retries</li><li>It should Not Write Retry If Number Of Retries Equal To Configured Retries&nbsp;</li><li>It should Not Write Retry If Number Of Retries Greater Than Configured Retries</li></ul><br /><div class="p2">Unavailable behaviour:</div><div class="p1"></div><ul><li>It should Unavailable Retry At The Same Consistency Level</li><li>It should Unavailable Retry If Number Of Retries Less Than Configured Retries</li><li>It should Not Unavailable Retry If Number Of RetriesGreater Than Configured Retries</li><li>It should Not Unavailable Retry If Number Of Retries Equal To Configured Retries</li></ul><div><br />Look like a crazy way to define the behaviour I want? Well actually these are just my test names that I implemented one at a time. I'm a big fan of Test Driven Development (TDD), I built the functionality with the above tests, making each pass before moving on. </div><div><br /></div><div>For example:</div><div><br /></div><br /><script src="https://gist.github.com/chbatey/6811469.js"></script> And the implementation:  <script src="https://gist.github.com/chbatey/6811509.js"></script><br /><br /><br /><br />You can view the full code on my github page:&nbsp;<a href="https://github.com/chbatey/java-driver/blob/2.0/driver-core/src/main/java/com/datastax/driver/core/policies/FixedNumberRetryPolicy.java" target="_blank">FixedNumberRetryPolicy</a><br /><br />And to use the new retry policy (assuming it is on your classpath):<br /><br /><script src="https://gist.github.com/chbatey/6811823.js"></script> We also wrap it in a LoggingRetryPolicy which logs any retries.<br /><br />Done!