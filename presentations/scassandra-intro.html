---
layout: presentation
---

<section>
  <h1>How do I test my Cassandra application?</h1>

  <!--<h3>Testing Cassandra the easy way</h3>-->

  <p>
    <small><a href="http://christopher-batey.co.uk">Christopher Batey</a> / <a
            href="http://twitter.com/chbatey">@chbatey</a></small>
  </p>

  <aside class="notes">
Questions for audience:
     1) Who is using Cassandra?
     2) Who is actively developing against Cassandra?
     3) Who has complex policies around retry / consistency?
  </aside>
</section>

<section>
  <h2>Overview</h2>
  <ul>
    <li>Cassandra overview</li>
    <li>Cassandra failure scenarios e.g ReadTimeout, WriteTimeout, Unavailable</li>
    <li>Existing technologies:</li>
    <ul>
      <li>CCM</li>
      <li>Cassandra Unit</li>
      <li>Mocking libraries</li>
      <li>Integration tests</li>
    </ul>
    <li>Stubbed Cassandra</li>
    <li>Conclusion</li>
  </ul>
</section>


<section>
  <h2>Cassandra</h2>
  <ul>
    <li>
      Cassandra is a distributed database that was open-sourced by Facebook
    </li>
    <li>
      Data model based on Google's Big Data paper
    </li>
    <li>Distributed architecture is based
      on Dynamo model
    </li>
    <li>
      Applications communicate with Cassandra using a driver that implements the Cassandra binary protocol
    </li>
  </ul>


  <aside class="notes">
    Horizontalable scaleable database.
    Large quantities of data
    Shines when active dataset does not fit into memory
    No single point of failure
  </aside>
</section>


<section>
  <h2>Single Node</h2>
  <ul>
    <li>
      Single application node, single Cassandra node
    </li>
    <li>
      All the data lives on the same node
    </li>
    <li>
      What could go wrong?
    </li>
  </ul>
  <img src="{{ "/presentations/scassandra-intro/images/onenode.png" | preprend: site.baseurl}}" />
  <aside class="notes">
    Only likely to be using Cassandra like this in dev / test environments.
  </aside>
</section>

<section>
  <h2>More realistic</h2>
  <ul>
    <li>
      N application nodes, 6 Cassandra nodes
    </li>
    <li>
      Each piece of data is replication 3 times
    </li>
    <li>
      What could go wrong?
    </li>
  </ul>
  <img src="{{ "/presentations/scassandra-intro/images/manynodes.png" | preprend: site.baseurl}}" />
</section>


<section>
  <h2>Tunable consistency</h2>
  <ul>
    <li>Each write/read is done at a consistency</li>
    <li>ANY, ONE, TWO, THREE, QUORUM, LOCAL_QUORUM, EACH_QUORUM, ALL</li>
    <li>Any more than ANY and ONE require a cluster of more than one node to make sense</li>
  </ul>
</section>

<section>

  <h2>Cassandra Read / Write Timeouts</h2>
  <ul>
    <li>
      Many failures occur only when your cluster comprises many nodes across different data centers
    </li>
    <li>
      How do you test this in a development environment?
    </li>
  </ul>
  <img src="{{ "/presentations/scassandra-intro/images/readtimeout.png" | preprend: site.baseurl}}" />

</section>

<section>
  <h2>Cassandra Unavailable</h2>
  <ul>
    <li>
      Many failures occur only when your cluser comprises many nodes across different data centers
    </li>
  </ul>
  <img src="{{ "/presentations/scassandra-intro/images/unavailable.png" | preprend: site.baseurl}}" />
</section>

<section>
  <h2>Unit testing / Integration testing</h2>

  <aside class="notes">
    Usually i call these developer tests.
  </aside>
</section>

<section>
  <h2>Acceptance testing</h2>
  <ul>
    <li>
      Usually done against a real Cassandra cluster
    </li>
    <li>
      Unavailable? Turn off most of the nodes
    </li>
    <li>
      Read/write timeouts? Large amounts of data, small timeouts
    </li>
  </ul>
  <img src="{{ "/presentations/scassandra-intro/images/acceptance.png" | preprend: site.baseurl}}" />
</section>

<section>
  <h2>Acceptance testing againt HTTP services?</h2>
</section>

<section>
  <h2>Stubbed Cassandra!</h2>
  <ul>
    <li>Implements the server side of the Cassandra binary protocol</li>
    <li>Pretends to be a real Cassandra</li>
    <li>Can be primed to return rows</li>
    <li>Can be primed to return errors, e.g. Read Request Timeout, Write Request Timeout</li>
  </ul>
  <img src="{{ "/presentations/scassandra-intro/images/scassandra.png" | preprend: site.baseurl}}" />
</section>


<section>
  <h2>Lets get going - Some code that needs testing</h2>
<pre><code data-trim contenteditable>
public List&lt;Person&gt; retrieveNames() {
    ResultSet result;
    try {
        Statement statement = new SimpleStatement(&quot;select * from person&quot;);
        statement.setConsistencyLevel(ConsistencyLevel.QUORUM);
        result = session.execute(statement);
    } catch (ReadTimeoutException e) {
        throw new UnableToRetrievePeopleException();
    }

    List&lt;Person&gt; people = new ArrayList&lt;&gt;();
    for (Row row : result) {
        people.add(new Person(row.getString(&quot;first_name&quot;), row.getInt(&quot;age&quot;)));
    }
    return people;
}
</code></pre>
</section>


<section>
  <h2>Test the query is issued at the correct consistnecy</h2>
          <pre><code data-trim contenteditable>
@Test
public void testQueryIssuedWithCorrectConsistency() {
      //given
      underTest.connect();
      Query expectedQuery = Query.builder().withQuery(&quot;select * from person&quot;)
          .withConsistency(&quot;QUORUM&quot;).build();

      //when
      underTest.retrieveNames();

      //then
      List&lt;Query&gt; queries = activityClient.retrieveQueries();
      assertTrue(&quot;Expected query with consistency QUORUM, found following queries: &quot; + queries,
      queries.contains(expectedQuery));
}
          </code></pre>
</section>

<section>
  <h2>Perhaps you prefer testing behaviour?</h2>
          <pre><code data-trim contenteditable>
public void testRetrievingOfNames() throws Exception{
    Map&lt;String, ? extends Object&gt; row = ImmutableMap.of(
        &quot;first_name&quot;, &quot;Chris&quot;,
        &quot;last_name&quot;, &quot;Batey&quot;,
        &quot;age&quot;, &quot;29&quot;);
    PrimingRequest singleRowPrime = queryBuilder()
        .withQuery(&quot;select * from person&quot;)
        .withRows(row)
        .build();
    primingClient.primeQuery(singleRowPrime);

    List&lt;Person&gt; names = underTest.retrieveNames();

    assertEquals(1, names.size());
    assertEquals(&quot;Chris&quot;, names.get(0).getName());
}
          </code></pre>
</section>

<section>
  <h2>Or how about the REST API</h2>

  <p>Priming</p>
          <pre><code data-trim contenteditable>
{
    &quot;when&quot;: {
    &quot;query&quot; :&quot;select * from people&quot;
    },
    &quot;then&quot;: {
        &quot;rows&quot; :[{&quot;name&quot;:&quot;Chris&quot;, &quot;age&quot;:&quot;28&quot;}, {&quot;name&quot;:&quot;Alexandra&quot;,
        &quot;age&quot;:&quot;24&quot;}]
      }
}
          </code></pre>
  <p>Activity Verification</p>
<pre><code data-trim contenteditable>
[{
    &quot;query&quot;: &quot;select * from people&quot;,
    &quot;consistency&quot;: &quot;TWO&quot;
}]
</code></pre>
</section>
<section>
  <h2>Testing errors</h2>
<pre><code data-trim contenteditable>
@Test(expected = UnableToRetrievePeopleException.class)
public void testHandlingOfReadRequestTimeout() throws Exception {
    // given
    PrimingRequest primeReadRequestTimeout = queryBuilder()
        .withQuery(&quot;select * from person&quot;)
        .withResult(Result.read_request_timeout)
        .build();
    primingClient.primeQuery(primeReadRequestTimeout);

    //when
    underTest.retrieveNames();
}
</code></pre>
</section>

<section>
  <h2>Testing retry policies</h2>
</section>

<section>
  <h2>What else can I do?</h2>
  <ul>
    <li>
      Start as many instances of Scassandra you like in the same JVM
    </li>
    <li>
      Prime all primitive types
    </li>
    <li>
      Prime sets and lists of type text
    </li>
    <li>
      Prime prepared statements
    </li>
    <li>
      Verify number of connections your application makes
  </ul>
</section>
<section>
  <section>
    <h2>So how does all this work?</h2>
    <ul>
      <li>
        Server implemented in Scala
      </li>
      <li>
        Binary port for your Cassandra application to connect to
      </li>
      <li>
        Admin port for the REST API
      </li>
      <li>
        Thin Java wrapper to make it easy to be used in JUnit tests
      </li>
    </ul>
  </section>
  <section>
    <h2>Lots more details</h2>
  </section>
</section>


<section>
  <h2>Java Developers - It is on Maven Central</h2>
					<pre><code data-trim contenteditable>
&lt;dependency&gt;
    &lt;groupid&gt;org.scassandra&lt;/groupid&gt;
    &lt;artifactid&gt;java-client&lt;/artifactid&gt;
    &lt;version&gt;0.2.1&lt;/version&gt;
    &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;
          </code></pre>

</section>

<section>
  <h2>Don't like Java?</h2>

  <p>
    Download a standalone execurable jar from www.scassandra.org
  </p>

  <p>
    It has a REST API to do all your priming
  </p>
</section>


<section>
  <h2>Where to find out more!</h2>
  <ul>
    <li><a href="https://github.com/scassandra/scassandra-server">Source code on GitHub: https://github.com/scassandra/scassandra-server</a></li>
    <li><a href="http://twitter.com/chbatey">Follow me on Twitter @chbatey</a></li>
  </ul>
</section>

<section>
  <h2>Future features</h2>
</section>

<section>
  <h2>Conclusion</h2>
  <ul>
    <li></li>
  </ul>
</section>

<section>
  <h1>THE END</h1>
  <h3>Stubbed Cassandra / scassandra.org</h3>
  <h3>BY Christopher Batey / christopher-batey.co.uk</h3>
</section>

